# Clang vs GCC

This page describes differences in AddressSanitizer between Clang and GCC (both runtime and compiler parts). The comparison was performed for relatively fresh versions of mentioned tools:

Clang: clang version 3.8.0 r255627 (http://llvm.org/viewvc/llvm-project/cfe?view=revision&revision=255627)<br>
LLVM:  LLVM  version 3.8.0 r255629 (http://llvm.org/viewvc/llvm-project?view=revision&revision=255629)<br>
Compiler-rt: r255594               (http://llvm.org/viewvc/llvm-project/compiler-rt?view=revision&revision=255594)<br>

GCC: gcc version 6.0.0 20151215 (experimental) r231646 (https://gcc.gnu.org/viewcvs/gcc?view=revision&revision=231646)

|                    Feature                   	|                        LLVM                       	|                                  GCC                                 	|                                                                                              BUGS/ML                                                                                              	|                                                                                                                                                                                                                                                                                  Cons and Pros                                                                                                                                                                                                                                                                                  	|
|:--------------------------------------------:	|:-------------------------------------------------:	|:--------------------------------------------------------------------:	|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:	|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|
|           UBSan embedded into Asan           	|                         +                         	|                                   -                                  	|                                                                      https://gcc.gnu.org/ml/gcc-patches/2015-10/msg01216.html                                                                     	|                                                                                                                                                                               Simplify Asan + UBSan usage. This doesn't work for GCC, because it links static libasan with -whole-archive option, so we end up with undefined references to C++ stuff required by UBSan runtime if use GCC driver.                                                                                                                                                                              	|
|       std containers overflow detection      	|                         +                         	|                             google branch                            	|                                  http://llvm.org/viewvc/llvm-project?view=revision&revision=208319 https://gcc.gnu.org/viewcvs/gcc?view=revision&revision=207517                                  	|                                                                                                                                                                                                                                                                       Support new kinds of bugs detection                                                                                                                                                                                                                                                                       	|
|       dynamic alloca overflow detection      	|                         +                         	|                       compiler support missing                       	|                                                                                                                                                                                                   	|                                                                                                                                                                                                                                                                       Support new kinds of bugs detection                                                                                                                                                                                                                                                                       	|
|      stack allocation via dynamic alloca     	|                         +                         	|                                   -                                  	|                                                                                                                                                                                                   	|                                                                                                                                                                                                                                                                        Less memory usage for non-UAR mode                                                                                                                                                                                                                                                                       	|
|       using private aliases for globals      	| * copy relocs bugs detection <br> * ODR violation detection 	| * separate sanitization of shared libraries <br>* local aliases bug detection 	| https://gcc.gnu.org/bugzilla/show_bug.cgi?id=63888 https://gcc.gnu.org/bugzilla/show_bug.cgi?id=68016 https://github.com/google/sanitizers/issues/398 https://llvm.org/bugs/show_bug.cgi?id=24486 	|                                                                                                                                                                               GCC flaws: <br> * false negatives on globals when copy relocations are involved. <br> * ODR violation detection doesn't work. <br><br> LLVM flaws: <br> * we need to re-link our binaries against each time we add/remove sanitized library.                                                                                                                                                                              	|
|                 KASan support                	|                      limited                      	|                                   +                                  	|                                                                         https://www.kernel.org/doc/Documentation/kasan.txt                                                                        	|                                                                                                                                                                                                                     Use Asan for kernel. Linux kernel still cannot be built via clang for most targets (for x86{,_64} you still need apply special patches).                                                                                                                                                                                                                    	|
|           asan_experiments support           	|                         +                         	|                                   -                                  	|                                http://llvm.org/viewvc/llvm-project?view=revision&revision=232501 <br> http://llvm.org/viewvc/llvm-project?view=revision&revision=232502                                	|                                                                                                                                                                                  The experiments can be used to evaluate potential optimizations that remove instrumentation (assess false negatives). This way we can figure out, what optimization causes false negatives in much easier way.                                                                                                                                                                                  	|
|        invalid pointer pairs detection       	|                         +                         	|                                   -                                  	|                                                                                                                                                                                                   	|                                                                                                                                                                                                                                                                       Support new kinds of bugs detection                                                                                                                                                                                                                                                                       	|
|               lifetime checking              	|                         +                         	|                                   -                                  	|                                                                                                                                                                                                   	|                                                                                                                                                                                                                                                         This is still experimental. Allows detect use after scope bugs.                                                                                                                                                                                                                                                         	|
|        default runtime library linkage       	|                       static                      	|                                dynamic                               	|                            https://github.com/google/sanitizers/wiki/AddressSanitizerAsDso https://github.com/google/sanitizers/issues/147  <br> http://reviews.llvm.org/D3042                           	| Cons of dynamic linkage: <br>* Worse performance (ASAN run-time is called via PLT even in the main executable) <br>* Issue 147 (on Google Code) (can't use -static-libstdc++ <br>* Harder deployment (need to carry the DSO around) <br>* __asan_init is not called from preinit_array and so there is a risk that an instrumented code will get called before __asan_init (may cause SEGV at startup; still unlikely)  <br><br> Proc of dynamic linkage: <br>* Smaller disk usage and memory footprint when multiple processes are running with ASan. <br>* Potential ability to bring old ASAN-ified binaries to new systems <br>* Ability to LD_PRELOAD ASAN-DSO. 	|
|             asan_symbolize script            	|                         +                         	|                                   -                                  	|                                                                                                                                                                                                   	|                                                                                                                                                                                                                                         The script itself is a useful feature, perhaps it should be embedded to GCC source tree as well.                                                                                                                                                                                                                                        	|
|      ARM ABI for frame pointer extrating     	|                      LLVM ABI                     	|                                GCC ABI                               	|                                                                         https://gcc.gnu.org/bugzilla/show_bug.cgi?id=61771                                                                        	|                                                                                                                                                                                                                                                                  GCC needs a special patch to handle the issue.                                                                                                                                                                                                                                                                 	|
|              support blacklists              	|                         +                         	|                                   -                                  	|                     http://clang.llvm.org/docs/AddressSanitizer.html#suppressing-errors-in-recompiled-code-blacklist  <br> https://gcc.gnu.org/ml/gcc-patches/2013-12/msg00649.html                     	|                                                                                                                                                                                                                                                              Clang is more flexible in controlling instrumentation.                                                                                                                                                                                                                                                             	|
|          support sanitizer coverage          	|                         +                         	|                  very limited, for Linux kernel only                 	|                                             http://clang.llvm.org/docs/SanitizerCoverage.html https://gcc.gnu.org/ml/gcc-patches/2015-12/msg00299.html                                            	|                                                                                                                                                                                    In Clang, ASan has good integration with fast and lightweight fuzzing library Libfuzzer (http://llvm.org/docs/LibFuzzer.html). In GCC, ASan is integrated with AFL only (http://lcamtuf.coredump.cx/afl/).                                                                                                                                                                                    	|
| reports deduplication for ASan recovery mode 	|                         +                         	|                                   -                                  	|                                                                                   http://reviews.llvm.org/D15080                                                                                  	|                                                                                                                                                                                                                                                                   In Clang, ASan recovery mode is much usable.                                                                                                                                                                                                                                                                  	|
|       support old Linux kernels (< 3.0)      	|                         -                         	|                                   +                                  	|                                                                                                                                                                                                   	|                                                                                                                                                                                                                                                                   In GCC, ASan works for older Linux kernels.                                                                                                                                                                                                                                                                   	|
|               using symbolizer               	|                  LLVM symbolizer                  	|                             libbacktrace                             	|                                                                                                                                                                                                   	|                                                                                                                                                                                                       GCC uses embedded libbacktrace library for symbolization that's statically linked with libasan. LLVM needs a separate llvm-symbolizer binary to print nice reports.                                                                                                                                                                                                       	|
|   symbol size changing for global variables  	|                         +                         	|                                   -                                  	|                                                 https://github.com/google/sanitizers/issues/619 https://gcc.gnu.org/bugzilla/show_bug.cgi?id=68016                                                	| In Clang, ASan changes size of global variables by appending redzone size to it. This is an ABI change and may cause runtime errors when/if other shared modules have been linked against non-sanitized version of the library.                                                                                                                                                                                                                                                                                                                                                 	 However, given that Clang should support not only ELF format (e.g. Windows and OS/X use different ones), it's complicated to make sure that target linker won't cut out right redzone for globals if not include it in symbol itself. GCC ASan generally supports ELF only, so it doesn't have such problems.|
|         adaptive global redzone sizes        	|                         +                         	|                                   -                                  	|                                                                                                                                                                                                   	| Possible better layout for globals in Clang.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    	|